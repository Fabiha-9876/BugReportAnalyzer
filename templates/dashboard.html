{% extends "base.html" %}
{% block title %}Dashboard - Bug Report Accuracy Analyzer{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="bi bi-speedometer2"></i> Dashboard</h2>
        <p class="text-muted">Overview of all projects and their testing accuracy</p>
    </div>
    <div class="col-auto">
        <a href="/upload" class="btn btn-primary"><i class="bi bi-cloud-upload"></i> Upload New Data</a>
    </div>
</div>

{% if projects %}
<!-- Global Summary -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card text-center shadow-sm border-start border-primary border-4">
            <div class="card-body">
                <h6 class="card-subtitle text-muted">Total Bugs Analyzed</h6>
                <h2 class="mt-2 mb-0">{{ global_totals.total_bugs }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center shadow-sm border-start border-success border-4">
            <div class="card-body">
                <h6 class="card-subtitle text-muted">Valid Bugs</h6>
                <h2 class="mt-2 mb-0 text-success">{{ global_totals.valid }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center shadow-sm border-start border-danger border-4">
            <div class="card-body">
                <h6 class="card-subtitle text-muted">Invalid Bugs</h6>
                <h2 class="mt-2 mb-0 text-danger">{{ global_totals.invalid }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center shadow-sm border-start border-secondary border-4">
            <div class="card-body">
                <h6 class="card-subtitle text-muted">Duplicates</h6>
                <h2 class="mt-2 mb-0 text-secondary">{{ global_totals.duplicate }}</h2>
            </div>
        </div>
    </div>
</div>

<!-- Global Charts -->
{% if all_cycles|length > 0 %}
<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-header">Overall Classification</div>
            <div class="card-body">
                <canvas id="globalDonut"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header">Accuracy Across All Cycles</div>
            <div class="card-body">
                <canvas id="globalAccuracyChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Project Cards -->
<h4 class="mb-3">Projects</h4>
<div class="row g-4">
    {% for p in projects %}
    <div class="col-md-4">
        <div class="card h-100 shadow-sm">
            <div class="card-body">
                <h5 class="card-title">{{ p.name }}</h5>
                <p class="card-text text-muted">{{ p.description or 'No description' }}</p>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span class="badge bg-secondary">{{ p.cycle_count }} cycle{{ 's' if p.cycle_count != 1 }}</span>
                    {% if p.latest_accuracy is not none %}
                    <div class="accuracy-badge {% if p.latest_accuracy >= 0.8 %}bg-success{% elif p.latest_accuracy >= 0.6 %}bg-warning{% else %}bg-danger{% endif %} text-white rounded-pill px-3 py-1">
                        {{ "%.0f"|format(p.latest_accuracy * 100) }}% Accuracy
                    </div>
                    {% else %}
                    <span class="badge bg-light text-dark">No data</span>
                    {% endif %}
                </div>
                {% if p.cycles %}
                <div class="list-group list-group-flush mb-2">
                    {% for c in p.cycles[-3:] %}
                    <a href="/cycles/{{ c.id }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-1 px-0 border-0">
                        <small>{{ c.name }}</small>
                        <small class="{% if c.metrics.testing_accuracy >= 0.8 %}text-success{% elif c.metrics.testing_accuracy >= 0.6 %}text-warning{% else %}text-danger{% endif %}">
                            {{ "%.0f"|format(c.metrics.testing_accuracy * 100) }}%
                        </small>
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            <div class="card-footer bg-transparent">
                <a href="/analytics/{{ p.id }}" class="btn btn-outline-primary btn-sm me-1">
                    <i class="bi bi-graph-up"></i> Analytics
                </a>
                {% if p.cycles %}
                <a href="/cycles/{{ p.cycles[-1].id }}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-list-ul"></i> Latest Cycle
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center py-5">
    <i class="bi bi-inbox display-1 text-muted"></i>
    <h4 class="mt-3">No projects yet</h4>
    <p class="text-muted">Upload a CSV file to create your first project and regression cycle.</p>
    <a href="/upload" class="btn btn-primary"><i class="bi bi-cloud-upload"></i> Upload Data</a>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if projects and all_cycles|length > 0 %}
<script>
    // Global donut
    const globalDist = {{ global_totals | tojson }};
    renderClassificationDonut('globalDonut', {
        valid: globalDist.valid,
        invalid: globalDist.invalid,
        duplicate: globalDist.duplicate
    });

    // Accuracy bar chart across all cycles
    const allCycles = {{ all_cycles | tojson }};
    waitForChart(function() {
        const ctx = document.getElementById('globalAccuracyChart');
        if (!ctx) return;
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: allCycles.map(c => c.name),
                datasets: [{
                    label: 'Testing Accuracy %',
                    data: allCycles.map(c => (c.metrics.testing_accuracy * 100).toFixed(1)),
                    backgroundColor: allCycles.map(c => {
                        const a = c.metrics.testing_accuracy;
                        return a >= 0.8 ? '#198754' : a >= 0.6 ? '#ffc107' : '#dc3545';
                    }),
                    borderRadius: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } }
                }
            }
        });
    });
</script>
{% endif %}
{% endblock %}
